import t,{useState as e,useRef as n,useCallback as r,forwardRef as o,useImperativeHandle as c,useMemo as i}from"react";import u from"tinycolor2";function a(t,e){const n=Math.round(Math.random()*e),r=1-Math.random()/4;return u(t).darken(n-e/2).setAlpha(r).toPercentageRgbString()}const l=(t,e,n)=>[n[0]+t*Math.cos(e),n[1]+t*Math.sin(e)];function s(t){return`url(${function(t){return`data:image/svg+xml;base64,${btoa(function(t){return`<svg xmlns='http://www.w3.org/2000/svg' width='${t}' height='${t}' viewBox='0 0 ${t} ${t}'><circle r='${t/2}' cy='${t/2}' cx='${t/2}' stroke-width='1' stroke='rgba(0,0,0,0.5)' fill='none'/></svg>`}(t))}`}(t)}) ${t/2} ${t/2}, crosshair`}function h({color:t="#000000",strokeWidth:o=25,varyBrightness:c=5}){const[i,u]=e([]),h=n(),d=n(),g=r(e=>{h.current=void 0,u(function(t,e,n){const r=[],o=Math.round(t/3),c=t/o;for(let t=0;t<o;t++){const o=0===t?0:c*t+Math.random()*c/2-c/2;r.push({distance:o,thickness:2*Math.random()+2,colour:a(e,n)})}return r}(o,t,c)),d.current=e},[u,o,t,c]);return{name:"Paintbrush",startStroke:g,continueStroke:r((t,e)=>{if(!d.current)return void(d.current=t);const n=((t,e,n)=>{const r=((t,e)=>(Math.atan2(e[1]-t[1],e[0]-t[0])-Math.PI/2)%(2*Math.PI))(t,e);return void 0===n?r:n-((t,e)=>{const n=2*Math.PI,r=(t-(e>0?e:e+n)+Math.PI)%n-Math.PI;return r<-Math.PI?r+n:r})(n,r)})(d.current,t,h.current);void 0===h.current&&(h.current=n%(2*Math.PI)),((t,e,n,r,o,c,i)=>{t.forEach(t=>{i.beginPath(),((t,e,n,r,o)=>{o.beginPath(),o.moveTo(t[0],t[1]),o.strokeStyle=n.colour,o.lineWidth=n.thickness,o.lineCap="round",o.lineJoin="round",o.shadowColor=n.colour,o.shadowBlur=n.thickness/2,o.quadraticCurveTo(r[0],r[1],e[0],e[1]),o.lineTo(e[0],e[1]),o.stroke()})(l(t.distance-c/2,r,e),l(t.distance-c/2,o,n),t,l(t.distance-c/2,o,e),i)})})(i,d.current,t,h.current,n,o,e),h.current=n%(2*Math.PI),d.current=t},[i,o]),cursor:s(o)}}function d({color:t="#000000",strokeWidth:e=25}){const o=n();return{name:"Marker pen",startStroke:r((e,n)=>{n.lineWidth=3,n.lineJoin=n.lineCap="round",o.current=e,n.strokeStyle=t},[t]),continueStroke:r((t,n)=>{if(o.current){if(o.current[0]!==t[0]||o.current[1]!==t[1]){n.beginPath();for(let r=0;r<e;r+=2){const c=Math.round(e/2-r);n.globalAlpha=1/e*(e-r),n.moveTo(o.current[0]-c,o.current[1]-c),n.lineTo(t[0]-c,t[1]-c),n.stroke()}n.globalAlpha=1,n.beginPath(),o.current=t}}else o.current=t},[e,o]),cursor:s(e)}}function g({color:t="#000000",strokeWidth:e=25}){const n=r((n,r)=>{r.globalCompositeOperation="darken",r.lineWidth=e,r.lineJoin=r.lineCap="round",r.strokeStyle=t,r.shadowBlur=.5*e,r.shadowColor=u(t).setAlpha(.5).toPercentageRgbString(),console.log(r.shadowColor),r.moveTo(n[0],n[1]),r.beginPath()},[t,e]),o=r(t=>{t.globalCompositeOperation="source-over"},[]);return{name:"Airbrush",startStroke:n,continueStroke:r((t,e)=>{e.lineTo(t[0],t[1]),e.stroke()},[]),endStroke:o,cursor:s(e)}}function f({color:t="#000000",neighbourColor:e,distanceThreshold:o=40,neighbourStrokeWidth:c=1,spreadFactor:i=.9}){e||(e=u(t).setAlpha(.2).toPercentageRgbString());const a=n([]),l=o*o;return{name:"Shading",startStroke:r((t,e)=>{e.globalCompositeOperation="darken",e.lineWidth=1,e.lineJoin=e.lineCap="round",a.current=[t]},[]),continueStroke:r((n,r)=>{r.strokeStyle=t,r.lineWidth=1,a.current.push(n),r.beginPath();const[o,u]=a.current[a.current.length-2];r.moveTo(o,u),r.lineTo(...n),r.stroke(),r.lineWidth=c;for(const t of a.current){const o=t[0]-n[0],c=t[1]-n[1],u=o*o+c*c;u<l&&Math.random()>u/l&&(r.beginPath(),r.strokeStyle=e,r.moveTo(n[0]+o*i,n[1]+c*i),r.lineTo(t[0]-o*i,t[1]-c*i),r.stroke())}},[c,t,i,l,e]),endStroke:r(t=>{t.globalCompositeOperation="source-over"},[]),cursor:"crosshair"}}let k=null;function p(){let t,e,n,r,o;if(null!==k)t=k,k=null;else{do{e=2*Math.random()-1,n=2*Math.random()-1,r=e*e+n*n}while(0===r||r>=1);o=Math.sqrt(-2*Math.log(r)/r),t=e*o,k=n*o}return t}function S(t,e,n,r,o){if(n<0)return[];const c=(t[1]+e[1])/2,i=[(t[0]+e[0])/2+p()*r,c+p()*r],u=S(t,i,n-1,r/o,o);return u.push(i),u.push(...S(i,e,n-1,r/o,o)),u}function v(t,e,n){e.beginPath(),function(t,e,n){return function(t,e,n){const r=[];for(let e=0;e<t.length;e++){const o=t[e],c=t[(e+1)%t.length];r.push(o),r.push(...S(o,c,5,n,2))}return r}(function(t,e,n){const r=2*Math.PI/e,o=[];for(let c=1;c<=e;c++)o.push([n*Math.cos(r*c)+t[0],n*Math.sin(r*c)+t[1]]);return o}(t,e,n),0,n/10)}(t,Math.round(n/5),n).forEach(t=>{e.lineTo(...t)}),e.closePath(),e.fill()}function m(t,e,n,r){const o=Math.min(n,t.length/3);for(let n=0;n<o;n++)r.globalAlpha=.01-.009/o*n,v(t[t.length-3*n-1],r,e+e/o*n);r.globalAlpha=.1}function b({color:t="#000000",strokeWidth:e=25}){const o=n([]),c=r((n,r)=>{r.fillStyle=t,r.shadowColor=t,r.globalAlpha=.01,o.current=[n],m(o.current,1.1*e,1,r)},[t,e]),i=r(()=>{o.current=[]},[]);return{name:"Watercolor",startStroke:c,continueStroke:r((t,n)=>{o.current.push(t),m(o.current,e,5,n)},[e]),endStroke:i,cursor:s(e)}}function M({strokeWidth:t=25}){return{name:"Eraser",startStroke:r((e,n)=>{n.globalCompositeOperation="source-over",n.lineWidth=t,n.strokeStyle="#ffffff",n.lineJoin=n.lineCap="round",n.moveTo(e[0],e[1]),n.beginPath()},[t]),continueStroke:r((t,e)=>{e.lineTo(t[0],t[1]),e.stroke()},[]),cursor:s(t)}}function w(){return w=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)({}).hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},w.apply(null,arguments)}const y=t=>{if(!t.currentTarget)return[0,0];const e=t.currentTarget.getBoundingClientRect(),n=t.targetTouches[0];return[n.clientX-e.left,n.clientY-e.top]},P=t=>[t.nativeEvent.offsetX,t.nativeEvent.offsetY],C=t=>!(1&~t),T=["tool","style","history","onStartStroke","onContinueStroke","onEndStroke"],W=o(function(n,o){let{tool:i,style:u,history:a,onStartStroke:l,onContinueStroke:s,onEndStroke:h}=n,d=function(t,e){if(null==t)return{};var n={};for(var r in t)if({}.hasOwnProperty.call(t,r)){if(-1!==e.indexOf(r))continue;n[r]=t[r]}return n}(n,T);const[g,f]=e(),[k,p]=e(),[S,v]=e(!1),m=r(t=>{g&&(g.save(),v(!0),null==i.startStroke||i.startStroke(t,g),null==l||l(t))},[i,g,l]),b=r(t=>{g&&(null==i.continueStroke||i.continueStroke(t,g),null==s||s(t))},[i,g,s]),M=r(()=>{v(!1),g&&(null==i.endStroke||i.endStroke(g),null==h||h(),g.restore(),k&&a&&a.pushState(k))},[i,g,k,a,h]),W=r(t=>{S&&b(P(t))},[b,S]),x=r(t=>{S&&b(y(t))},[b,S]),O=r(t=>{S||(t.preventDefault(),m(P(t)))},[S,m]),R=r(t=>{S||m(y(t))},[S,m]),I=r(()=>{g&&k&&(g.save(),g.fillStyle="rgba(255, 255, 255, 0)",g.fillRect(0,0,k.width,k.height),g.restore(),k&&a&&a.pushState(k))},[g,k,a]),A=r(t=>{if(!t)return;t.width=t.offsetWidth,t.height=t.offsetHeight;const e=t.getContext("2d");p(t),f(e),e&&(e.fillStyle="rgba(255, 255, 255, 0)",e.fillRect(0,0,t.width,t.height),e.fillStyle="transparent",a&&(a.setContext(e),a.pushState(t)))},[a]),E=r(t=>{C(t.buttons)?O(t):S&&M()},[S,O,M]),$=r(t=>{S&&(b(P(t)),M())},[b,S,M]);return c(o,()=>({download:(t="image.png",e)=>{if(!k)return;const n=document.createElement("a");n.href=k.toDataURL(e),n.download=t,n.click()},clear:I,getImageAsDataUri:t=>null==k?void 0:k.toDataURL(t),context:g}),[k,g,I]),t.createElement("canvas",w({style:w({cursor:null==i?void 0:i.cursor,touchAction:"none"},u),onTouchStart:R,onMouseDown:O,onMouseEnter:E,onMouseMove:S?W:void 0,onTouchMove:S?x:void 0,onMouseUp:M,onMouseOut:$,onTouchEnd:M,ref:A},d))});async function x(t,e){const n=new Image;n.onload=()=>{t.canvas.width=n.width,t.canvas.height=n.height,t.drawImage(n,0,0),URL.revokeObjectURL(n.src)},n.src=URL.createObjectURL(e)}function O(t){const o=n([]),c=n(0),[u,a]=e(),[l,s]=e(!1),[h,d]=e(!1),g=r(async e=>{const n=c.current;if(!u)return console.error("Context not initialised"),!1;0!==n&&(o.current=o.current.slice(0,-n),c.current=0);const r=await new Promise(t=>e.toBlob(t));return r&&o.current.push(r),t&&o.current.length>t&&(o.current=o.current.slice(-t)),s(o.current.length>1),d(!1),!0},[c,o,u]),f=r(async()=>{const t=c.current;return u?t+1>=o.current.length?(console.log("nope"),!1):(await x(u,o.current[o.current.length-(t+2)]),c.current++,s(c.current+1<o.current.length),d(!0),!0):(console.error("Context not initialised"),!1)},[c,o,u]),k=r(async()=>{const t=c.current;return u?!(t<=0||(await x(u,o.current[o.current.length-t]),c.current--,s(c.current+1<o.current.length),d(c.current>0),0)):(console.error("Context not initialised"),!1)},[o,c,u]),p=r(()=>{o.current=[]},[o]),S=i(()=>({setContext:t=>{a(t)},pushState:g}),[a,g]);return{history:S,undo:f,redo:k,clear:p,canUndo:l,canRedo:h}}export{W as Artboard,s as circleCursor,P as getMousePoint,y as getTouchPoint,C as mouseButtonIsDown,g as useAirbrush,h as useBrush,M as useEraser,O as useHistory,d as useMarker,f as useShadingBrush,b as useWatercolor};
//# sourceMappingURL=index.modern.js.map
