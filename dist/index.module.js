import t,{useState as r,useRef as n,useCallback as e,forwardRef as o,useImperativeHandle as i,useMemo as u}from"react";import a from"tinycolor2";function c(t,r){var n=Math.round(Math.random()*r),e=1-Math.random()/4;return a(t).darken(n-r/2).setAlpha(e).toPercentageRgbString()}var l=function(t,r,n){return[n[0]+t*Math.cos(r),n[1]+t*Math.sin(r)]};function s(t){return"url("+function(t){return"data:image/svg+xml;base64,"+btoa(function(t){return"<svg xmlns='http://www.w3.org/2000/svg' width='"+t+"' height='"+t+"' viewBox='0 0 "+t+" "+t+"'><circle r='"+t/2+"' cy='"+t/2+"' cx='"+t/2+"' stroke-width='1' stroke='rgba(0,0,0,0.5)' fill='none'/></svg>"}(t))}(t)+") "+t/2+" "+t/2+", crosshair"}function h(t){var o=t.color,i=void 0===o?"#000000":o,u=t.strokeWidth,a=void 0===u?25:u,h=t.varyBrightness,f=void 0===h?5:h,d=r([]),v=d[0],g=d[1],p=n(),m=n(),k=e(function(t){p.current=void 0,g(function(t,r,n){for(var e=[],o=Math.round(t/3),i=t/o,u=0;u<o;u++){var a=0===u?0:i*u+Math.random()*i/2-i/2;e.push({distance:a,thickness:2*Math.random()+2,colour:c(r,n)})}return e}(a,i,f)),m.current=t},[g,a,i,f]);return{name:"Paintbrush",startStroke:k,continueStroke:e(function(t,r){if(m.current){var n=(s=p.current,u=m.current,c=t,h=(Math.atan2(c[1]-u[1],c[0]-u[0])-Math.PI/2)%(2*Math.PI),void 0===s?h:s-(e=h,o=2*Math.PI,(i=(s-(e>0?e:e+o)+Math.PI)%o-Math.PI)<-Math.PI?i+o:i));void 0===p.current&&(p.current=n%(2*Math.PI)),function(t,r,n,e,o,i,u){t.forEach(function(t){u.beginPath(),function(t,r,n,e,o){o.beginPath(),o.moveTo(t[0],t[1]),o.strokeStyle=n.colour,o.lineWidth=n.thickness,o.lineCap="round",o.lineJoin="round",o.shadowColor=n.colour,o.shadowBlur=n.thickness/2,o.quadraticCurveTo(e[0],e[1],r[0],r[1]),o.lineTo(r[0],r[1]),o.stroke()}(l(t.distance-i/2,e,r),l(t.distance-i/2,o,n),t,l(t.distance-i/2,o,r),u)})}(v,m.current,t,p.current,n,a,r),p.current=n%(2*Math.PI),m.current=t}else m.current=t;var e,o,i,u,c,s,h},[v,a]),cursor:s(a)}}function f(t){var r=t.color,o=void 0===r?"#000000":r,i=t.strokeWidth,u=void 0===i?25:i,a=n();return{name:"Marker pen",startStroke:e(function(t,r){r.lineWidth=3,r.lineJoin=r.lineCap="round",a.current=t,r.strokeStyle=o},[o]),continueStroke:e(function(t,r){if(a.current){if(a.current[0]!==t[0]||a.current[1]!==t[1]){r.beginPath();for(var n=0;n<u;n+=2){var e=Math.round(u/2-n);r.globalAlpha=1/u*(u-n),r.moveTo(a.current[0]-e,a.current[1]-e),r.lineTo(t[0]-e,t[1]-e),r.stroke()}r.globalAlpha=1,r.beginPath(),a.current=t}}else a.current=t},[u,a]),cursor:s(u)}}function d(t){var r=t.color,n=void 0===r?"#000000":r,o=t.strokeWidth,i=void 0===o?25:o,u=e(function(t,r){r.globalCompositeOperation="darken",r.lineWidth=i,r.lineJoin=r.lineCap="round",r.strokeStyle=n,r.shadowBlur=.5*i,r.shadowColor=a(n).setAlpha(.5).toPercentageRgbString(),console.log(r.shadowColor),r.moveTo(t[0],t[1]),r.beginPath()},[n,i]),c=e(function(t){t.globalCompositeOperation="source-over"},[]);return{name:"Airbrush",startStroke:u,continueStroke:e(function(t,r){r.lineTo(t[0],t[1]),r.stroke()},[]),endStroke:c,cursor:s(i)}}function v(t,r){(null==r||r>t.length)&&(r=t.length);for(var n=0,e=Array(r);n<r;n++)e[n]=t[n];return e}function g(){return g=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var e in n)({}).hasOwnProperty.call(n,e)&&(t[e]=n[e])}return t},g.apply(null,arguments)}function p(t){var r=t.color,o=void 0===r?"#000000":r,i=t.neighbourColor,u=t.distanceThreshold,c=void 0===u?40:u,l=t.neighbourStrokeWidth,s=void 0===l?1:l,h=t.spreadFactor,f=void 0===h?.9:h;i||(i=a(o).setAlpha(.2).toPercentageRgbString());var d=n([]),g=c*c;return{name:"Shading",startStroke:e(function(t,r){r.globalCompositeOperation="darken",r.lineWidth=1,r.lineJoin=r.lineCap="round",d.current=[t]},[]),continueStroke:e(function(t,r){r.strokeStyle=o,r.lineWidth=1,d.current.push(t),r.beginPath();var n=d.current[d.current.length-2];r.moveTo(n[0],n[1]),r.lineTo.apply(r,t),r.stroke(),r.lineWidth=s;for(var e,u=function(t){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(r)return(r=r.call(t)).next.bind(r);if(Array.isArray(t)||(r=function(t,r){if(t){if("string"==typeof t)return v(t,r);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?v(t,r):void 0}}(t))){r&&(t=r);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(d.current);!(e=u()).done;){var a=e.value,c=a[0]-t[0],l=a[1]-t[1],h=c*c+l*l;h<g&&Math.random()>h/g&&(r.beginPath(),r.strokeStyle=i,r.moveTo(t[0]+c*f,t[1]+l*f),r.lineTo(a[0]-c*f,a[1]-l*f),r.stroke())}},[s,o,f,g,i]),endStroke:e(function(t){t.globalCompositeOperation="source-over"},[]),cursor:"crosshair"}}var m=null;function k(){var t,r,n,e,o;if(null!==m)t=m,m=null;else{do{e=(r=2*Math.random()-1)*r+(n=2*Math.random()-1)*n}while(0===e||e>=1);t=r*(o=Math.sqrt(-2*Math.log(e)/e)),m=n*o}return t}function S(t,r,n,e,o){if(n<0)return[];var i=(t[1]+r[1])/2,u=[(t[0]+r[0])/2+k()*e,i+k()*e],a=S(t,u,n-1,e/o,o);return a.push(u),a.push.apply(a,S(u,r,n-1,e/o,o)),a}function b(t,r,n){r.beginPath(),function(t,r,n){return function(t,r,n){for(var e=[],o=0;o<t.length;o++){var i=t[o],u=t[(o+1)%t.length];e.push(i),e.push.apply(e,S(i,u,5,n,2))}return e}(function(t,r,n){for(var e=2*Math.PI/r,o=[],i=1;i<=r;i++)o.push([n*Math.cos(e*i)+t[0],n*Math.sin(e*i)+t[1]]);return o}(t,r,n),0,n/10)}(t,Math.round(n/5),n).forEach(function(t){r.lineTo.apply(r,t)}),r.closePath(),r.fill()}function y(t,r,n,e){for(var o=Math.min(n,t.length/3),i=0;i<o;i++)e.globalAlpha=.01-.009/o*i,b(t[t.length-3*i-1],e,r+r/o*i);e.globalAlpha=.1}function P(t){var r=t.color,o=void 0===r?"#000000":r,i=t.strokeWidth,u=void 0===i?25:i,a=n([]),c=e(function(t,r){r.fillStyle=o,r.shadowColor=o,r.globalAlpha=.01,a.current=[t],y(a.current,1.1*u,1,r)},[o,u]),l=e(function(){a.current=[]},[]);return{name:"Watercolor",startStroke:c,continueStroke:e(function(t,r){a.current.push(t),y(a.current,u,5,r)},[u]),endStroke:l,cursor:s(u)}}function M(t){var r=t.strokeWidth,n=void 0===r?25:r;return{name:"Eraser",startStroke:e(function(t,r){r.globalCompositeOperation="source-over",r.lineWidth=n,r.strokeStyle="#ffffff",r.lineJoin=r.lineCap="round",r.moveTo(t[0],t[1]),r.beginPath()},[n]),continueStroke:e(function(t,r){r.lineTo(t[0],t[1]),r.stroke()},[]),cursor:s(n)}}var w=function(t){if(!t.currentTarget)return[0,0];var r=t.currentTarget.getBoundingClientRect(),n=t.targetTouches[0];return[n.clientX-r.left,n.clientY-r.top]},C=function(t){return[t.nativeEvent.offsetX,t.nativeEvent.offsetY]},T=function(t){return!(1&~t)},A=["tool","style","history","onStartStroke","onContinueStroke","onEndStroke"],I=o(function(n,o){var u=n.tool,a=n.style,c=n.history,l=n.onStartStroke,s=n.onContinueStroke,h=n.onEndStroke,f=function(t,r){if(null==t)return{};var n={};for(var e in t)if({}.hasOwnProperty.call(t,e)){if(-1!==r.indexOf(e))continue;n[e]=t[e]}return n}(n,A),d=r(),v=d[0],p=d[1],m=r(),k=m[0],S=m[1],b=r(!1),y=b[0],P=b[1],M=e(function(t){v&&(v.save(),P(!0),null==u.startStroke||u.startStroke(t,v),null==l||l(t))},[u,v,l]),I=e(function(t){v&&(null==u.continueStroke||u.continueStroke(t,v),null==s||s(t))},[u,v,s]),W=e(function(){P(!1),v&&(null==u.endStroke||u.endStroke(v),null==h||h(),v.restore(),k&&c&&c.pushState(k))},[u,v,k,c,h]),x=e(function(t){y&&I(C(t))},[I,y]),O=e(function(t){y&&I(w(t))},[I,y]),R=e(function(t){y||(t.preventDefault(),M(C(t)))},[y,M]),E=e(function(t){y||M(w(t))},[y,M]),j=e(function(){v&&k&&(v.save(),v.fillStyle="rgba(255, 255, 255, 0)",v.fillRect(0,0,k.width,k.height),v.restore(),k&&c&&c.pushState(k))},[v,k,c]),U=e(function(t){if(t){t.width=t.offsetWidth,t.height=t.offsetHeight;var r=t.getContext("2d");S(t),p(r),r&&(r.fillStyle="rgba(255, 255, 255, 0)",r.fillRect(0,0,t.width,t.height),r.fillStyle="transparent",c&&(c.setContext(r),c.pushState(t)))}},[c]),B=e(function(t){T(t.buttons)?R(t):y&&W()},[y,R,W]),L=e(function(t){y&&(I(C(t)),W())},[I,y,W]);return i(o,function(){return{download:function(t,r){if(void 0===t&&(t="image.png"),k){var n=document.createElement("a");n.href=k.toDataURL(r),n.download=t,n.click()}},clear:j,getImageAsDataUri:function(t){return null==k?void 0:k.toDataURL(t)},context:v}},[k,v,j]),t.createElement("canvas",g({style:g({cursor:null==u?void 0:u.cursor,touchAction:"none"},a),onTouchStart:E,onMouseDown:R,onMouseEnter:B,onMouseMove:y?x:void 0,onTouchMove:y?O:void 0,onMouseUp:W,onMouseOut:L,onTouchEnd:W,ref:U},f))}),W=function(t,r){try{var n=new Image;return n.onload=function(){t.canvas.width=n.width,t.canvas.height=n.height,t.drawImage(n,0,0),URL.revokeObjectURL(n.src)},n.src=URL.createObjectURL(r),Promise.resolve()}catch(t){return Promise.reject(t)}};function x(t){var o=n([]),i=n(0),a=r(),c=a[0],l=a[1],s=r(!1),h=s[0],f=s[1],d=r(!1),v=d[0],g=d[1],p=e(function(r){try{var n=i.current;return c?(0!==n&&(o.current=o.current.slice(0,-n),i.current=0),Promise.resolve(new Promise(function(t){return r.toBlob(t)})).then(function(r){return r&&o.current.push(r),t&&o.current.length>t&&(o.current=o.current.slice(-t)),f(o.current.length>1),g(!1),!0})):(console.error("Context not initialised"),Promise.resolve(!1))}catch(t){return Promise.reject(t)}},[i,o,c]),m=e(function(){try{var t=i.current;return c?t+1>=o.current.length?(console.log("nope"),Promise.resolve(!1)):Promise.resolve(W(c,o.current[o.current.length-(t+2)])).then(function(){return i.current++,f(i.current+1<o.current.length),g(!0),!0}):(console.error("Context not initialised"),Promise.resolve(!1))}catch(t){return Promise.reject(t)}},[i,o,c]),k=e(function(){try{var t=i.current;return c?t<=0?Promise.resolve(!1):Promise.resolve(W(c,o.current[o.current.length-t])).then(function(){return i.current--,f(i.current+1<o.current.length),g(i.current>0),!0}):(console.error("Context not initialised"),Promise.resolve(!1))}catch(t){return Promise.reject(t)}},[o,i,c]),S=e(function(){o.current=[]},[o]),b=u(function(){return{setContext:function(t){l(t)},pushState:p}},[l,p]);return{history:b,undo:m,redo:k,clear:S,canUndo:h,canRedo:v}}export{I as Artboard,s as circleCursor,C as getMousePoint,w as getTouchPoint,T as mouseButtonIsDown,d as useAirbrush,h as useBrush,M as useEraser,x as useHistory,f as useMarker,p as useShadingBrush,P as useWatercolor};
//# sourceMappingURL=index.module.js.map
